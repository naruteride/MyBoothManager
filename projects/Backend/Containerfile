### BUILD STAGE ###
FROM node:lts-alpine as build

# Copy files
WORKDIR /build
COPY packages/        packages/
COPY projects/Backend projects/Backend

# Build common package
WORKDIR /build/packages/Common
RUN yarn set version berry
RUN yarn install
RUN yarn build

# Build backend
WORKDIR /build/projects/Backend
RUN yarn set version berry
RUN yarn install
RUN yarn build

### PRODUCTION STAGE ###
FROM node:lts-alpine as production

# Copy files
WORKDIR /app
COPY              ./package.json                         ./package.json
COPY --from=build /build/packages/Common/dist          packages/Common
COPY --from=build /build/packages/Common/package.json  packages/Common/package.json
COPY --from=build /build/projects/Backend/dist         projects/Backend
COPY --from=build /build/projects/Backend/package.json projects/Backend/package.json

# Using Yarn Berry
RUN yarn set version berry

# Install production dependencies
RUN yarn workspaces focus @myboothmanager/backend --production

# Expose port
EXPOSE 31111

# Start server
ENTRYPOINT ["yarn", "--cwd", "projects/Backend", "start:prod"]
