### BUILD STAGE ###
FROM node:lts-alpine as build

# Copy files
WORKDIR /build
COPY packages/        packages/
COPY projects/Backend projects/Backend

# Build common package
WORKDIR /build/packages/Common
# Workaround
RUN rm .containerignore
RUN yarn set version berry
RUN yarn install
RUN yarn build

# Build backend
WORKDIR /build/projects/Backend
RUN yarn set version berry
RUN yarn install
RUN yarn build

### PRODUCTION STAGE ###
FROM node:lts-alpine as production

# Copy files
WORKDIR /app
COPY              ./package.json                       ./package.json
COPY --from=build /build/packages/Common/dist          packages/Common/dist
COPY --from=build /build/packages/Common/package.json  packages/Common/package.json
COPY --from=build /build/projects/Backend/dist         projects/Backend/dist
COPY --from=build /build/projects/Backend/package.json projects/Backend/package.json

# Using Yarn Berry
RUN yarn set version berry

# Install production dependencies
RUN yarn workspaces focus @myboothmanager/backend --production

# DB migration
RUN printf "\n\n  *** DB MIGRATION WILL BE EXECUTED ***  \n - You can undo migration manually by running 'yarn workspace @myboothmanager/backend migrate down' if there's any issue. \n\n"
RUN yarn workspace @myboothmanager/backend migrate up

# Expose port
EXPOSE 31111

# Start server
ENTRYPOINT ["yarn", "workspace", "@myboothmanager/backend", "start:prod"]
