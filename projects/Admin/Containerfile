### BUILD STAGE ###
FROM node:lts-alpine as build

# Copy files
WORKDIR /build
COPY packages/      packages/
COPY projects/Admin projects/Admin

# Build common package
WORKDIR /build/packages/Common
RUN yarn set version berry
RUN yarn install
RUN yarn build

# Build admin frontend
WORKDIR /build/projects/Admin
RUN yarn set version berry
RUN yarn install
RUN yarn build

### PRODUCTION STAGE ###
FROM node:lts-alpine as production

# Copy files
WORKDIR /app
COPY --from=build /build/projects/Admin/dist .

# Expose port
EXPOSE 31112

# Start server
ENTRYPOINT ["yarn", "dlx", "http-server", "--proxy", "http://localhost:31112?", "--port", "31112"]
